{% extends "base.html" %}

{% block title %}Dashboard - SANA{% endblock %}

{% block extra_head %}
<style>
    .filtro-prioridade.active {
        background-color: #3b82f6 !important;
        color: white !important;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    .dark .filtro-prioridade.active {
        background-color: #3b82f6 !important;
        color: white !important;
    }

    /* Melhorias para modo escuro - Cards de alunos */
    .dark .aluno-card-critica {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
        border-left-color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
    }

    .dark .aluno-card-alta {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(234, 88, 12, 0.1) 100%);
        border-left-color: #f97316;
        border-color: rgba(249, 115, 22, 0.3);
    }

    .dark .aluno-card-media {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(202, 138, 4, 0.1) 100%);
        border-left-color: #eab308;
        border-color: rgba(234, 179, 8, 0.3);
    }

    /* Cores dos √≠cones no modo escuro */
    .dark .icon-critica { color: #f87171 !important; }
    .dark .icon-alta { color: #fb923c !important; }
    .dark .icon-media { color: #fbbf24 !important; }

    /* Badges no modo escuro */
    .dark .badge-reprovacao {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .dark .badge-recuperacao {
        background: rgba(249, 115, 22, 0.2);
        color: #fdba74;
        border: 1px solid rgba(249, 115, 22, 0.3);
    }

    .dark .badge-aprovacao {
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .dark .badge-disciplina {
        background: rgba(239, 68, 68, 0.15);
        color: #fca5a5;
        border: 1px solid rgba(239, 68, 68, 0.25);
    }

    /* Hover effects no modo escuro */
    .dark .aluno-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    /* Estilos para ranking de melhores alunos */
    .ranking-item {
        transition: all 0.3s ease;
    }

    .ranking-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .dark .ranking-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .posicao-1 { border-left-color: #ffd700; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%); }
    .posicao-2 { border-left-color: #c0c0c0; background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(192, 192, 192, 0.05) 100%); }
    .posicao-3 { border-left-color: #cd7f32; background: linear-gradient(135deg, rgba(205, 127, 50, 0.1) 0%, rgba(205, 127, 50, 0.05) 100%); }

    .dark .posicao-1 { background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.08) 100%); }
    .dark .posicao-2 { background: linear-gradient(135deg, rgba(192, 192, 192, 0.15) 0%, rgba(192, 192, 192, 0.08) 100%); }
    .dark .posicao-3 { background: linear-gradient(135deg, rgba(205, 127, 50, 0.15) 0%, rgba(205, 127, 50, 0.08) 100%); }

    .medal-icon-1 { color: #ffd700; }
    .medal-icon-2 { color: #c0c0c0; }
    .medal-icon-3 { color: #cd7f32; }

    .disciplina-tag {
        display: inline-block;
        padding: 2px 6px;
        margin: 1px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
    }

    .disciplina-excelente { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
    .disciplina-boa { background: rgba(59, 130, 246, 0.2); color: #2563eb; }
    .disciplina-media { background: rgba(234, 179, 8, 0.2); color: #ca8a04; }
    .disciplina-baixa { background: rgba(239, 68, 68, 0.2); color: #dc2626; }

    .dark .disciplina-excelente { background: rgba(34, 197, 94, 0.3); color: #86efac; }
    .dark .disciplina-boa { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
    .dark .disciplina-media { background: rgba(234, 179, 8, 0.3); color: #fbbf24; }
    .dark .disciplina-baixa { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }

    /* Estilos para lista expans√≠vel de alunos que precisam aten√ß√£o */
    .aluno-item-compacto {
        transition: all 0.3s ease;
        cursor: pointer;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .aluno-item-compacto:hover {
        background-color: rgba(0, 0, 0, 0.05);
        transform: translateX(3px);
    }

    .dark .aluno-item-compacto:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .aluno-detalhes {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        padding: 0 16px;
    }

    .aluno-detalhes.expandido {
        max-height: 500px;
        padding: 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        margin-top: 8px;
    }

    .dark .aluno-detalhes.expandido {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    .chevron-icon {
        transition: transform 0.3s ease;
    }

    .chevron-icon.rotacionado {
        transform: rotate(90deg);
    }

    .prioridade-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .prioridade-critica { background: rgba(239, 68, 68, 0.2); color: #dc2626; }
    .prioridade-alta { background: rgba(249, 115, 22, 0.2); color: #ea580c; }
    .prioridade-media { background: rgba(234, 179, 8, 0.2); color: #ca8a04; }

    .dark .prioridade-critica { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
    .dark .prioridade-alta { background: rgba(249, 115, 22, 0.3); color: #fdba74; }
    .dark .prioridade-media { background: rgba(234, 179, 8, 0.3); color: #fbbf24; }

    /* Estilos para navega√ß√£o entre se√ß√µes */
    .secao-btn {
        background: transparent;
        color: #6b7280;
        border: 1px solid transparent;
    }

    .secao-btn:hover {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border-color: rgba(59, 130, 246, 0.2);
    }

    .secao-btn.active {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .dark .secao-btn {
        color: #9ca3af;
    }

    .dark .secao-btn:hover {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
    }

    .dark .secao-btn.active {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
    }

    .secao-content {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .secao-content.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">üìä Dashboard Acad√™mico</h1>
                <p class="mt-2 text-gray-600 dark:text-dark-300">Vis√£o geral do desempenho da turma e an√°lises estat√≠sticas</p>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    <i class="fas fa-school mr-2"></i>Turma:
                </label>
                <select id="select-turma-ativa" class="px-4 py-2 bg-white dark:bg-dark-700 text-gray-900 dark:text-white rounded-lg border border-gray-300 dark:border-dark-600 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Carregando turmas...</option>
                </select>

                <!-- Indicador de Trimestre -->
                <div id="indicador-trimestre" class="hidden">
                    <span id="badge-trimestre" class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold">
                        <i class="fas fa-calendar-alt mr-1.5"></i>
                        <span id="texto-trimestre">Carregando...</span>
                    </span>
                    <div id="progresso-trimestres" class="ml-3 hidden md:flex items-center gap-2">
                        <div class="flex items-center gap-1">
                            <div id="prog-tri-1" class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">1¬∫</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div id="prog-tri-2" class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">2¬∫</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div id="prog-tri-3" class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600"></div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">3¬∫</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navega√ß√£o entre Se√ß√µes -->
    <div class="mb-8">
        <div class="flex flex-wrap gap-2 bg-white dark:bg-dark-800 p-2 rounded-xl shadow-lg dark:shadow-2xl border border-gray-200 dark:border-dark-600">
            <button onclick="mostrarSecao('turma')" id="btn-secao-turma" class="secao-btn active px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                <i class="fas fa-school"></i>
                <span>Dashboard da Turma</span>
            </button>
            <button onclick="mostrarSecao('alunos')" id="btn-secao-alunos" class="secao-btn px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                <i class="fas fa-user-graduate"></i>
                <span>Dashboard dos Alunos</span>
            </button>
        </div>
    </div>

    <!-- Se√ß√£o: Dashboard da Turma -->
    <div id="secao-turma" class="secao-content">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 flex items-center">
                <i class="fas fa-school mr-3 text-blue-600 dark:text-blue-400"></i>
                Vis√£o Geral da Turma
            </h2>
            <p class="text-gray-600 dark:text-gray-300">Estat√≠sticas gerais e an√°lises de desempenho da turma</p>
        </div>

        <!-- Estat√≠sticas Gerais -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="stats-section">
        <div class="stat-card rounded-xl p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-users text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-dark-300">Total de Alunos</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="total-alunos">-</p>
                </div>
            </div>
        </div>

        <div class="stat-card rounded-xl p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400">
                    <i class="fas fa-book text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-dark-300">Disciplinas</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="total-disciplinas">-</p>
                </div>
            </div>
        </div>

        <div class="stat-card rounded-xl p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-dark-300">M√©dia Geral</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="media-geral">-</p>
                </div>
            </div>
        </div>

        <div class="stat-card rounded-xl p-6 card-hover">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-dark-300">% com Dificuldade</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="percentual-dificuldade">-</p>
                </div>
            </div>
        </div>
    </div>



    <!-- Gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg dark:shadow-2xl p-6 card-hover border border-gray-200 dark:border-dark-600">
            <div class="flex items-center mb-4">
                <i class="fas fa-chart-bar text-indigo-600 dark:text-indigo-400 mr-2"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Disciplinas com Maior Dificuldade</h3>
            </div>
            <div id="grafico-dificuldade" class="grafico-container w-full h-96">
                <div class="text-center">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-300">Carregando gr√°fico...</p>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg dark:shadow-2xl p-6 card-hover border border-gray-200 dark:border-dark-600">
            <div class="flex items-center mb-4">
                <i class="fas fa-chart-pie text-purple-600 dark:text-purple-400 mr-2"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Distribui√ß√£o do Desempenho</h3>
            </div>
            <div id="grafico-pizza" class="grafico-container w-full h-96">
                <div class="text-center">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-300">Carregando gr√°fico...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg dark:shadow-2xl p-6 card-hover mb-8 border border-gray-200 dark:border-dark-600">
        <div class="flex items-center mb-4">
            <i class="fas fa-chart-line text-cyan-600 dark:text-cyan-400 mr-2"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Evolu√ß√£o das Notas por Trimestre</h3>
        </div>

        <!-- Filtro de Disciplinas -->
        <div class="mb-6 p-4 bg-gray-50 dark:bg-dark-700 rounded-lg border border-gray-200 dark:border-dark-600">
            <div class="flex flex-wrap items-center gap-3 mb-3">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    <i class="fas fa-filter mr-2"></i>Filtrar Disciplinas:
                </label>
                <button id="btn-selecionar-todas" class="px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors">
                    Selecionar Todas
                </button>
                <button id="btn-limpar-selecao" class="px-3 py-1 text-xs bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors">
                    Limpar Sele√ß√£o
                </button>
            </div>
            <div id="filtro-disciplinas" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                <!-- Checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
        </div>

        <div id="grafico-trimestres" class="grafico-container w-full h-96">
            <div class="text-center">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300">Carregando gr√°fico...</p>
            </div>
        </div>
    </div>

        <!-- Ranking de Disciplinas -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg dark:shadow-2xl p-6 card-hover border border-gray-200 dark:border-dark-600">
            <div class="flex items-center mb-4">
                <i class="fas fa-trophy text-yellow-600 dark:text-yellow-400 mr-2"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ranking de Disciplinas por Dificuldade</h3>
            </div>
            <div id="ranking-disciplinas" class="flex items-center justify-center py-8">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o: Dashboard dos Alunos -->
    <div id="secao-alunos" class="secao-content hidden">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 flex items-center">
                <i class="fas fa-user-graduate mr-3 text-green-600 dark:text-green-400"></i>
                An√°lise Individual dos Alunos
            </h2>
            <p class="text-gray-600 dark:text-gray-300">Rankings, alunos que precisam de aten√ß√£o e an√°lises individuais</p>
        </div>

        <!-- Alunos que Precisam de Aten√ß√£o -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg dark:shadow-2xl p-6 card-hover mb-8 border border-gray-200 dark:border-dark-600">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-600 dark:text-red-400 mr-3 text-xl"></i>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Alunos que Precisam de Aten√ß√£o</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600 dark:text-gray-300">Total:</span>
                    <span id="total-alunos-atencao" class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-full text-sm font-medium">-</span>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-alunos-atencao" class="text-center py-8">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300">Carregando alunos...</p>
            </div>

            <!-- Lista de Alunos -->
            <div id="lista-alunos-atencao" class="hidden">
                <!-- Filtros -->
                <div class="mb-4 flex flex-wrap gap-2">
                    <button onclick="filtrarPorPrioridade('todas')" class="filtro-prioridade active px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-dark-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-dark-600 transition-all duration-200 border border-gray-300 dark:border-dark-600" data-prioridade="todas">
                        <i class="fas fa-list mr-1"></i>Todas
                    </button>
                    <button onclick="filtrarPorPrioridade('Cr√≠tica')" class="filtro-prioridade px-4 py-2 rounded-full text-sm font-medium bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/40 transition-all duration-200 border border-red-300 dark:border-red-700/50" data-prioridade="Cr√≠tica">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Cr√≠tica
                    </button>
                    <button onclick="filtrarPorPrioridade('Alta')" class="filtro-prioridade px-4 py-2 rounded-full text-sm font-medium bg-orange-100 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-900/40 transition-all duration-200 border border-orange-300 dark:border-orange-700/50" data-prioridade="Alta">
                        <i class="fas fa-exclamation-circle mr-1"></i>Alta
                    </button>
                    <button onclick="filtrarPorPrioridade('M√©dia')" class="filtro-prioridade px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-300 hover:bg-yellow-200 dark:hover:bg-yellow-900/40 transition-all duration-200 border border-yellow-300 dark:border-yellow-700/50" data-prioridade="M√©dia">
                        <i class="fas fa-info-circle mr-1"></i>M√©dia
                    </button>
                </div>

                <!-- Lista Compacta de Alunos -->
                <div id="lista-alunos-atencao-compacta" class="space-y-2">
                    <!-- Alunos ser√£o inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- Estado Vazio -->
            <div id="empty-alunos-atencao" class="hidden text-center py-8">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Excelente!</h4>
                <p class="text-gray-600 dark:text-gray-300">Nenhum aluno precisa de aten√ß√£o especial no momento.</p>
            </div>
        </div>

        <!-- Ranking dos Melhores Alunos -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-lg dark:shadow-2xl p-6 card-hover mb-8 border border-gray-200 dark:border-dark-600">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-trophy text-yellow-600 dark:text-yellow-400 mr-3 text-xl"></i>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ranking dos Melhores Alunos</h3>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600 dark:text-gray-300">Top:</span>
                    <select id="limite-ranking" onchange="carregarRankingMelhoresAlunos()" class="px-2 py-1 bg-gray-100 dark:bg-dark-700 text-gray-700 dark:text-gray-300 rounded text-sm border border-gray-300 dark:border-dark-600">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-ranking-melhores" class="text-center py-8">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300">Carregando ranking...</p>
            </div>

            <!-- Lista de Ranking -->
            <div id="lista-ranking-melhores" class="hidden">
                <div id="grid-ranking-melhores" class="space-y-3">
                    <!-- Alunos ser√£o inseridos aqui via JavaScript -->
                </div>
            </div>

            <!-- Estado Vazio -->
            <div id="empty-ranking-melhores" class="hidden text-center py-8">
                <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Nenhum dado encontrado</h4>
                <p class="text-gray-600 dark:text-gray-300">N√£o foi poss√≠vel carregar o ranking dos alunos.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Vari√°veis globais para o filtro
    let dadosTrimestres = null;
    let disciplinasSelecionadas = new Set();
    let turmaAtiva = null;

    // Carregar dados iniciais
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado, iniciando carregamento dos dados...');
        carregarListaTurmas();

        // Adicionar listener para mudan√ßa de turma
        document.getElementById('select-turma-ativa').addEventListener('change', function() {
            const turmaSelecionada = this.value;
            if (turmaSelecionada) {
                selecionarTurma(turmaSelecionada);
            }
        });
    });

    function carregarListaTurmas() {
        fetch('/api/turmas', { headers: setAuthHeaders() })
            .then(response => response.json())
            .then(turmas => {
                const select = document.getElementById('select-turma-ativa');
                select.innerHTML = '';

                // A API retorna diretamente um array de turmas
                if (turmas && turmas.length > 0) {
                    turmas.forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma.nome;
                        option.textContent = `${turma.nome} (${turma.total_alunos} alunos)`;
                        select.appendChild(option);
                    });

                    // Selecionar primeira turma automaticamente
                    turmaAtiva = turmas[0].nome;
                    selecionarTurma(turmaAtiva);
                } else {
                    select.innerHTML = '<option value="">Nenhuma turma cadastrada</option>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar turmas:', error);
                document.getElementById('select-turma-ativa').innerHTML = '<option value="">Erro ao carregar</option>';
            });
    }

    function selecionarTurma(nomeTurma) {
        console.log('Selecionando turma:', nomeTurma);
        turmaAtiva = nomeTurma;

        // Fazer requisi√ß√£o para selecionar turma no backend
        fetch(`/api/turmas/selecionar/${encodeURIComponent(nomeTurma)}`, {
            method: 'POST',
            headers: setAuthHeaders()
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                console.log('Turma selecionada com sucesso:', data.turma);
                // Recarregar todos os dados da dashboard
                recarregarDashboard();
            } else {
                console.error('Erro ao selecionar turma:', data.erro);
                alert('Erro ao selecionar turma: ' + data.erro);
            }
        })
        .catch(error => {
            console.error('Erro ao selecionar turma:', error);
            alert('Erro ao selecionar turma');
        });
    }

    function recarregarDashboard() {
        console.log('Recarregando dashboard...');
        carregarInfoTrimestre();
        carregarEstatisticas();
        carregarDadosTrimestres();
        carregarAlunosAtencao();
        carregarRankingMelhoresAlunos();
        setTimeout(() => {
            carregarGraficos();
        }, 500);
        carregarRanking();
    }

    function carregarInfoTrimestre() {
        fetch('/api/info-trimestre', { headers: setAuthHeaders() })
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    console.error('Erro ao carregar info trimestre:', data.erro);
                    return;
                }

                // Mostrar indicador
                document.getElementById('indicador-trimestre').classList.remove('hidden');
                document.getElementById('indicador-trimestre').classList.add('flex', 'items-center');

                // Atualizar texto e cor do badge
                const badgeTrimestre = document.getElementById('badge-trimestre');
                const textoTrimestre = document.getElementById('texto-trimestre');
                textoTrimestre.textContent = data.status;

                // Definir cores baseado no trimestre
                badgeTrimestre.className = 'inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold';

                if (data.trimestre_atual === 1) {
                    badgeTrimestre.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900/30', 'dark:text-blue-300');
                } else if (data.trimestre_atual === 2) {
                    badgeTrimestre.classList.add('bg-purple-100', 'text-purple-800', 'dark:bg-purple-900/30', 'dark:text-purple-300');
                } else if (data.trimestre_atual === 3 && data.status === "Ano Letivo Completo") {
                    badgeTrimestre.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-300');
                } else {
                    badgeTrimestre.classList.add('bg-indigo-100', 'text-indigo-800', 'dark:bg-indigo-900/30', 'dark:text-indigo-300');
                }

                // Atualizar indicadores de progresso
                const trimestresCompletos = data.trimestres_completos || [];

                // Resetar todos
                ['prog-tri-1', 'prog-tri-2', 'prog-tri-3'].forEach(id => {
                    const elem = document.getElementById(id);
                    elem.className = 'w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600';
                });

                // Marcar completos
                trimestresCompletos.forEach(tri => {
                    const elem = document.getElementById(`prog-tri-${tri}`);
                    elem.className = 'w-2 h-2 rounded-full bg-green-500 dark:bg-green-400';
                });

                // Marcar em andamento
                if (data.trimestre_atual && !trimestresCompletos.includes(data.trimestre_atual)) {
                    const elem = document.getElementById(`prog-tri-${data.trimestre_atual}`);
                    elem.className = 'w-2 h-2 rounded-full bg-yellow-500 dark:bg-yellow-400 animate-pulse';
                }

                console.log('Info trimestre carregada:', data);
            })
            .catch(error => {
                console.error('Erro ao carregar info trimestre:', error);
            });
    }



    function carregarEstatisticas() {
        fetch('/api/relatorio-geral', {
            headers: setAuthHeaders()
        })
            .then(response => {
                if (handleAuthError(response)) return;
                return response.json();
            })
            .then(data => {
                if (data) {
                    document.getElementById('total-alunos').textContent = data.total_alunos;
                    document.getElementById('total-disciplinas').textContent = data.total_disciplinas;
                    document.getElementById('media-geral').textContent = data.media_geral_turma.toFixed(1);
                    document.getElementById('percentual-dificuldade').textContent = data.percentual_dificuldade.toFixed(1) + '%';
                }
            })
            .catch(error => console.error('Erro ao carregar estat√≠sticas:', error));
    }

    function carregarGraficos() {
        console.log('=== INICIANDO CARREGAMENTO DOS GR√ÅFICOS ===');
        console.log('Plotly dispon√≠vel:', typeof Plotly !== 'undefined');
        console.log('Window.Plotly:', window.Plotly);

        // Atualizar status
        document.getElementById('grafico-dificuldade').innerHTML = '<p class="text-blue-500 text-center">Verificando Plotly...</p>';
        document.getElementById('grafico-pizza').innerHTML = '<p class="text-blue-500 text-center">Verificando Plotly...</p>';
        document.getElementById('grafico-trimestres').innerHTML = '<p class="text-blue-500 text-center">Verificando Plotly...</p>';

        // Aguardar mais um pouco se Plotly n√£o estiver dispon√≠vel
        if (typeof Plotly === 'undefined') {
            console.log('Plotly n√£o dispon√≠vel, aguardando...');
            document.getElementById('grafico-dificuldade').innerHTML = '<p class="text-yellow-500 text-center">Aguardando Plotly carregar...</p>';

            setTimeout(() => {
                if (typeof Plotly !== 'undefined') {
                    console.log('Plotly carregou ap√≥s delay!');
                    carregarGraficos();
                } else {
                    console.error('Plotly n√£o carregou mesmo ap√≥s delay');
                    document.getElementById('grafico-dificuldade').innerHTML = '<p class="text-red-500 text-center">Plotly n√£o carregou</p>';
                    document.getElementById('grafico-pizza').innerHTML = '<p class="text-red-500 text-center">Plotly n√£o carregou</p>';
                    document.getElementById('grafico-trimestres').innerHTML = '<p class="text-red-500 text-center">Plotly n√£o carregou</p>';
                }
            }, 2000);
            return;
        }

        console.log('Plotly dispon√≠vel, carregando gr√°ficos...');
        document.getElementById('grafico-dificuldade').innerHTML = '<p class="text-green-500 text-center">Plotly OK, carregando dados...</p>';

        carregarGraficoReal();
    }

    function carregarGraficoReal() {
        console.log('Carregando gr√°ficos reais...');

        if (window.useChartJS || typeof Plotly === 'undefined') {
            console.log('Usando Chart.js como fallback');
            carregarGraficosChartJS();
        } else {
            console.log('Usando Plotly');
            carregarGraficosPlotly();
        }
    }

    function carregarGraficosPlotly() {
        const config = {
            responsive: true,
            displayModeBar: false,
            staticPlot: false
        };

        // Gr√°fico de dificuldade
        fetch('/api/grafico-dificuldade', {
            headers: setAuthHeaders()
        })
            .then(response => {
                if (handleAuthError(response)) return;
                return response.json();
            })
            .then(plotData => {
                if (!plotData) return;
                console.log('Dados recebidos:', plotData);

                // Aplicar tema escuro se necess√°rio
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) {
                    plotData.layout.paper_bgcolor = '#1e293b';
                    plotData.layout.plot_bgcolor = '#334155';
                    plotData.layout.font = {color: '#e2e8f0'};
                    if (plotData.layout.xaxis) plotData.layout.xaxis.gridcolor = '#475569';
                    if (plotData.layout.yaxis) plotData.layout.yaxis.gridcolor = '#475569';
                }

                // Configura√ß√µes de layout centralizadas
                plotData.layout.autosize = true;
                plotData.layout.margin = {l: 60, r: 40, t: 60, b: 100};
                plotData.layout.height = 320;
                plotData.layout.width = undefined; // Deixar autom√°tico

                Plotly.newPlot('grafico-dificuldade', plotData.data, plotData.layout, config);
                console.log('Gr√°fico de dificuldade plotado com Plotly');
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('grafico-dificuldade').innerHTML = '<p class="text-red-500 dark:text-red-400 text-center">Erro: ' + error.message + '</p>';
            });

        // Gr√°fico de pizza
        fetch('/api/grafico-pizza-desempenho')
            .then(response => response.json())
            .then(plotData => {
                // Aplicar tema escuro se necess√°rio
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) {
                    plotData.layout.paper_bgcolor = '#1e293b';
                    plotData.layout.plot_bgcolor = '#334155';
                    plotData.layout.font = {color: '#e2e8f0'};
                }

                // Configura√ß√µes de layout centralizadas
                plotData.layout.autosize = true;
                plotData.layout.margin = {l: 40, r: 40, t: 60, b: 40};
                plotData.layout.height = 320;
                plotData.layout.width = undefined; // Deixar autom√°tico

                Plotly.newPlot('grafico-pizza', plotData.data, plotData.layout, config);
                console.log('Gr√°fico de pizza plotado com Plotly');
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('grafico-pizza').innerHTML = '<p class="text-red-500 dark:text-red-400 text-center">Erro: ' + error.message + '</p>';
            });

        // Gr√°fico de trimestres agora √© carregado via filtros
        console.log('Gr√°fico de trimestres ser√° carregado via sistema de filtros');
    }

    function carregarGraficosChartJS() {
        console.log('Carregando gr√°ficos com Chart.js...');

        // Gr√°fico de dificuldade com Chart.js
        fetch('/api/grafico-dificuldade')
            .then(response => response.json())
            .then(plotData => {
                console.log('Dados recebidos para Chart.js:', plotData);

                // Converter dados do Plotly para Chart.js
                const data = plotData.data[0];

                // Detectar modo escuro
                const isDark = document.documentElement.classList.contains('dark');

                // Configurar container
                const container = document.getElementById('grafico-dificuldade');
                container.innerHTML = '<canvas id="chart-dificuldade"></canvas>';
                container.className = 'grafico-container w-full h-96';

                const ctx = document.getElementById('chart-dificuldade').getContext('2d');

                // Configura√ß√µes de cores baseadas no tema
                const colors = {
                    background: isDark ? 'rgba(147, 51, 234, 0.8)' : 'rgba(99, 102, 241, 0.8)',
                    border: isDark ? 'rgba(147, 51, 234, 1)' : 'rgba(99, 102, 241, 1)',
                    text: isDark ? '#e2e8f0' : '#374151',
                    grid: isDark ? '#475569' : '#e5e7eb'
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.x,
                        datasets: [{
                            label: 'Percentual de Dificuldade (%)',
                            data: data.y,
                            backgroundColor: colors.background,
                            borderColor: colors.border,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Disciplinas com Maior Dificuldade',
                                font: {
                                    size: 16
                                },
                                color: colors.text,
                                padding: 20
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Percentual (%)',
                                    color: colors.text
                                },
                                ticks: {
                                    color: colors.text
                                },
                                grid: {
                                    color: colors.grid
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Disciplinas',
                                    color: colors.text
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    color: colors.text
                                },
                                grid: {
                                    color: colors.grid
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10,
                                left: 10,
                                right: 10
                            }
                        }
                    }
                });
                console.log('Gr√°fico de dificuldade criado com Chart.js');
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('grafico-dificuldade').innerHTML = '<p class="text-red-500 dark:text-red-400 text-center">Erro: ' + error.message + '</p>';
            });

        // Placeholder para outros gr√°ficos com melhor estilo
        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? 'text-purple-400' : 'text-blue-500';

        document.getElementById('grafico-pizza').innerHTML = `
            <div class="w-full h-full flex items-center justify-center">
                <div class="text-center p-8">
                    <i class="fas fa-chart-pie text-4xl ${textColor} mb-4"></i>
                    <p class="${textColor} text-lg font-medium">Gr√°fico de Pizza</p>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">Dispon√≠vel com Plotly</p>
                </div>
            </div>
        `;

        // Gr√°fico de trimestres agora usa sistema de filtros
        console.log('Gr√°fico de trimestres ser√° carregado via sistema de filtros');
    }

    function carregarDadosTrimestres() {
        console.log('Carregando dados dos trimestres...');
        fetch('/api/dados-trimestres', {
            headers: setAuthHeaders()
        })
            .then(response => {
                if (handleAuthError(response)) return;
                return response.json();
            })
            .then(dados => {
                if (dados) {
                    console.log('Dados dos trimestres recebidos:', dados);
                    dadosTrimestres = dados;
                    criarFiltrosDisciplinas();
                    // Selecionar as primeiras 3 disciplinas por padr√£o
                    const primeiras3 = dados.disciplinas.slice(0, 3);
                    console.log('Selecionando disciplinas padr√£o:', primeiras3.map(d => d.nome));
                    primeiras3.forEach(disc => disciplinasSelecionadas.add(disc.nome));
                    atualizarCheckboxes();
                    // Carregar gr√°fico inicial ap√≥s carregar os dados
                    setTimeout(() => {
                        console.log('Carregando gr√°fico inicial...');
                        atualizarGraficoTrimestres();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Erro ao carregar dados dos trimestres:', error);
            });
    }

    function criarFiltrosDisciplinas() {
        if (!dadosTrimestres) {
            console.log('Dados dos trimestres n√£o dispon√≠veis');
            return;
        }

        console.log('Criando filtros para', dadosTrimestres.disciplinas.length, 'disciplinas');
        const container = document.getElementById('filtro-disciplinas');
        if (!container) {
            console.error('Container filtro-disciplinas n√£o encontrado');
            return;
        }

        container.innerHTML = '';

        dadosTrimestres.disciplinas.forEach(disciplina => {
            const div = document.createElement('div');
            div.className = 'flex items-center';

            div.innerHTML = `
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox"
                           class="checkbox-disciplina mr-2 rounded border-gray-300 dark:border-dark-500 text-blue-600 focus:ring-blue-500 dark:focus:ring-blue-400"
                           value="${disciplina.nome}"
                           onchange="toggleDisciplina('${disciplina.nome}')">
                    <span class="text-sm text-gray-700 dark:text-gray-300 flex items-center">
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${disciplina.cor}"></span>
                        ${disciplina.nome}
                    </span>
                </label>
            `;

            container.appendChild(div);
        });

        console.log('Filtros criados com sucesso');

        // Adicionar event listeners aos bot√µes
        const btnTodas = document.getElementById('btn-selecionar-todas');
        const btnLimpar = document.getElementById('btn-limpar-selecao');

        if (btnTodas) btnTodas.onclick = selecionarTodas;
        if (btnLimpar) btnLimpar.onclick = limparSelecao;

        console.log('Event listeners adicionados aos bot√µes');
    }

    function toggleDisciplina(nome) {
        if (disciplinasSelecionadas.has(nome)) {
            disciplinasSelecionadas.delete(nome);
        } else {
            disciplinasSelecionadas.add(nome);
        }
        atualizarGraficoTrimestres();
    }

    function selecionarTodas() {
        disciplinasSelecionadas.clear();
        dadosTrimestres.disciplinas.forEach(disc => disciplinasSelecionadas.add(disc.nome));
        atualizarCheckboxes();
        atualizarGraficoTrimestres();
    }

    function limparSelecao() {
        disciplinasSelecionadas.clear();
        atualizarCheckboxes();
        atualizarGraficoTrimestres();
    }

    function atualizarCheckboxes() {
        const checkboxes = document.querySelectorAll('.checkbox-disciplina');
        checkboxes.forEach(checkbox => {
            checkbox.checked = disciplinasSelecionadas.has(checkbox.value);
        });
    }

    function atualizarGraficoTrimestres() {
        if (!dadosTrimestres || disciplinasSelecionadas.size === 0) {
            document.getElementById('grafico-trimestres').innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <i class="fas fa-info-circle text-4xl text-blue-500 dark:text-blue-400 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-300">Selecione pelo menos uma disciplina para visualizar o gr√°fico</p>
                    </div>
                </div>
            `;
            return;
        }

        // Criar gr√°fico com disciplinas selecionadas
        if (typeof Plotly !== 'undefined') {
            criarGraficoTrimestresPlotly();
        } else {
            criarGraficoTrimestresChartJS();
        }
    }

    function criarGraficoTrimestresPlotly() {
        const fig = {
            data: [],
            layout: {
                title: 'Evolu√ß√£o das Notas por Trimestre',
                xaxis: { title: 'Trimestres' },
                yaxis: { title: 'Nota M√©dia' },
                template: 'plotly_white',
                height: 320,
                font: { size: 12 },
                legend: {
                    orientation: "v",
                    yanchor: "top",
                    y: 1,
                    xanchor: "left",
                    x: 1.02
                },
                autosize: true,
                margin: { l: 60, r: 40, t: 60, b: 80 }
            }
        };

        // Aplicar tema escuro se necess√°rio
        const isDark = document.documentElement.classList.contains('dark');
        if (isDark) {
            fig.layout.paper_bgcolor = '#1e293b';
            fig.layout.plot_bgcolor = '#334155';
            fig.layout.font.color = '#e2e8f0';
            fig.layout.xaxis.gridcolor = '#475569';
            fig.layout.yaxis.gridcolor = '#475569';
        }

        // Adicionar traces para disciplinas selecionadas
        dadosTrimestres.disciplinas.forEach(disciplina => {
            if (disciplinasSelecionadas.has(disciplina.nome)) {
                fig.data.push({
                    x: dadosTrimestres.trimestres,
                    y: disciplina.valores,
                    mode: 'lines+markers',
                    name: disciplina.nome,
                    line: { color: disciplina.cor, width: 3 },
                    marker: { size: 8 },
                    hovertemplate: `<b>${disciplina.nome}</b><br>Trimestre: %{x}<br>Nota M√©dia: %{y:.1f}<br><extra></extra>`
                });
            }
        });

        const config = { responsive: true, displayModeBar: false };
        Plotly.newPlot('grafico-trimestres', fig.data, fig.layout, config);
    }

    function criarGraficoTrimestresChartJS() {
        const container = document.getElementById('grafico-trimestres');
        container.innerHTML = '<canvas id="chart-trimestres"></canvas>';
        container.className = 'grafico-container w-full h-96';

        const ctx = document.getElementById('chart-trimestres').getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');

        const datasets = [];
        dadosTrimestres.disciplinas.forEach(disciplina => {
            if (disciplinasSelecionadas.has(disciplina.nome)) {
                datasets.push({
                    label: disciplina.nome,
                    data: disciplina.valores,
                    borderColor: disciplina.cor,
                    backgroundColor: disciplina.cor + '20',
                    borderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.1
                });
            }
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dadosTrimestres.trimestres,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    title: {
                        display: true,
                        text: 'Evolu√ß√£o das Notas por Trimestre',
                        font: { size: 16 },
                        color: isDark ? '#e2e8f0' : '#374151'
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            color: isDark ? '#e2e8f0' : '#374151'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Nota M√©dia',
                            color: isDark ? '#e2e8f0' : '#374151'
                        },
                        ticks: { color: isDark ? '#e2e8f0' : '#374151' },
                        grid: { color: isDark ? '#475569' : '#e5e7eb' }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Trimestres',
                            color: isDark ? '#e2e8f0' : '#374151'
                        },
                        ticks: { color: isDark ? '#e2e8f0' : '#374151' },
                        grid: { color: isDark ? '#475569' : '#e5e7eb' }
                    }
                }
            }
        });
    }

    function carregarRanking() {
        fetch('/api/ranking-disciplinas')
            .then(response => response.json())
            .then(data => {
                let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-dark-600">';
                html += '<thead class="bg-gray-50 dark:bg-dark-700"><tr>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-dark-300 uppercase tracking-wider">Posi√ß√£o</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-dark-300 uppercase tracking-wider">Disciplina</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-dark-300 uppercase tracking-wider">% Dificuldade</th>';
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-dark-300 uppercase tracking-wider">Alunos com Dificuldade</th>';
                html += '</tr></thead><tbody class="bg-white dark:bg-dark-800 divide-y divide-gray-200 dark:divide-dark-600">';

                data.forEach((item, index) => {
                    const bgColor = index % 2 === 0 ? 'bg-white dark:bg-dark-800' : 'bg-gray-50 dark:bg-dark-700';
                    const badgeColor = index < 3 ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300' : 'bg-gray-100 dark:bg-dark-600 text-gray-800 dark:text-dark-200';

                    html += `<tr class="${bgColor}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColor}">
                                ${item.posicao}¬∫
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${item.disciplina}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-dark-300">${item.percentual_dificuldade}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-dark-300">${item.alunos_com_dificuldade}/${item.total_alunos}</td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                document.getElementById('ranking-disciplinas').innerHTML = html;
            })
            .catch(error => {
                console.error('Erro ao carregar ranking:', error);
                document.getElementById('ranking-disciplinas').innerHTML = '<p class="text-red-500 dark:text-red-400 text-center">Erro ao carregar ranking</p>';
            });
    }

    // Vari√°veis globais para alunos que precisam de aten√ß√£o
    let alunosAtencaoData = [];
    let prioridadeFiltro = 'todas';

    // Vari√°veis globais para ranking de melhores alunos
    let rankingMelhoresData = [];

    function carregarAlunosAtencao() {
        console.log('Carregando alunos que precisam de aten√ß√£o...');

        const isProfessor = {{ 'true' if session.get('user_role') == 'professor' else 'false' }};
        const qs = isProfessor ? ('?disciplina=' + encodeURIComponent(document.getElementById('select-disciplina')?.value || '')) : '';
        fetch('/api/alunos-atencao' + qs, {
            headers: setAuthHeaders()
        })
            .then(response => {
                if (handleAuthError(response)) return;
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log('Dados de alunos que precisam de aten√ß√£o:', data);
                    alunosAtencaoData = data.alunos;

                    // Atualizar contador
                    document.getElementById('total-alunos-atencao').textContent = data.total;

                    // Mostrar/ocultar se√ß√µes apropriadas
                    if (data.total === 0) {
                        document.getElementById('loading-alunos-atencao').classList.add('hidden');
                        document.getElementById('lista-alunos-atencao').classList.add('hidden');
                        document.getElementById('empty-alunos-atencao').classList.remove('hidden');
                    } else {
                        document.getElementById('loading-alunos-atencao').classList.add('hidden');
                        document.getElementById('empty-alunos-atencao').classList.add('hidden');
                        document.getElementById('lista-alunos-atencao').classList.remove('hidden');

                        // Renderizar alunos
                        renderizarAlunosAtencao();
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar alunos que precisam de aten√ß√£o:', error);
                document.getElementById('loading-alunos-atencao').innerHTML =
                    '<p class="text-red-500 dark:text-red-400 text-center">Erro ao carregar dados</p>';
            });
    }

    function renderizarAlunosAtencao() {
        const lista = document.getElementById('lista-alunos-atencao-compacta');

        // Filtrar alunos por prioridade
        let alunosFiltrados = prioridadeFiltro === 'todas'
            ? alunosAtencaoData
            : alunosAtencaoData.filter(aluno => aluno.prioridade === prioridadeFiltro);

        // Ordenar por prioridade e depois por nome (alfab√©tica/num√©rica)
        const prioridadeOrdem = {"Cr√≠tica": 0, "Alta": 1, "M√©dia": 2};
        alunosFiltrados.sort((a, b) => {
            // Primeiro por prioridade
            const prioridadeA = prioridadeOrdem[a.prioridade];
            const prioridadeB = prioridadeOrdem[b.prioridade];
            if (prioridadeA !== prioridadeB) {
                return prioridadeA - prioridadeB;
            }
            // Depois por nome (ordem alfab√©tica/num√©rica)
            return a.nome.localeCompare(b.nome, undefined, {numeric: true, sensitivity: 'base'});
        });

        if (alunosFiltrados.length === 0) {
            lista.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">Nenhum aluno encontrado para este filtro.</div>';
            return;
        }

        let html = '';
        alunosFiltrados.forEach((aluno, index) => {
            const prioridadeClass = {
                'Cr√≠tica': 'prioridade-critica',
                'Alta': 'prioridade-alta',
                'M√©dia': 'prioridade-media'
            };

            const iconePrioridade = {
                'Cr√≠tica': 'fas fa-user-injured text-red-500 dark:text-red-400',
                'Alta': 'fas fa-user-clock text-orange-500 dark:text-orange-400',
                'M√©dia': 'fas fa-user-edit text-yellow-500 dark:text-yellow-400'
            };

            html += `
                <div class="aluno-item-compacto bg-white dark:bg-dark-800 border border-gray-200 dark:border-dark-600 rounded-lg">
                    <!-- Cabe√ßalho Compacto (sempre vis√≠vel) -->
                    <div class="flex items-center justify-between p-4 cursor-pointer" onclick="toggleAlunoDetalhes(${index})">
                        <div class="flex items-center space-x-3">
                            <i class="${iconePrioridade[aluno.prioridade]} text-lg"></i>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white">${aluno.nome}</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="prioridade-badge ${prioridadeClass[aluno.prioridade]}">${aluno.prioridade}</span>
                                    <span class="text-sm text-gray-600 dark:text-gray-300">M√©dia: ${aluno.media_geral}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex space-x-1 text-xs">
                                ${aluno.total_reprovacoes > 0 ? `<span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded">${aluno.total_reprovacoes}R</span>` : ''}
                                ${aluno.total_recuperacoes > 0 ? `<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded">${aluno.total_recuperacoes}Rec</span>` : ''}
                                <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded">${aluno.total_aprovacoes}A</span>
                            </div>
                            <i class="fas fa-chevron-right chevron-icon text-gray-400" id="chevron-${index}"></i>
                        </div>
                    </div>

                    <!-- Detalhes Expans√≠veis (inicialmente ocultos) -->
                    <div class="aluno-detalhes" id="detalhes-${index}">
                        <div class="space-y-4">
                            <!-- Resumo de Desempenho -->
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                    <div class="text-2xl font-bold text-red-600 dark:text-red-400">${aluno.total_reprovacoes}</div>
                                    <div class="text-xs text-red-600 dark:text-red-400">Reprova√ß√µes</div>
                                </div>
                                <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                                    <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">${aluno.total_recuperacoes}</div>
                                    <div class="text-xs text-orange-600 dark:text-orange-400">Recupera√ß√µes</div>
                                </div>
                                <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">${aluno.total_aprovacoes}</div>
                                    <div class="text-xs text-green-600 dark:text-green-400">Aprova√ß√µes</div>
                                </div>
                            </div>

                            <!-- Disciplinas com Problemas -->
                            ${aluno.disciplinas_reprovado.length > 0 ? `
                                <div>
                                    <h5 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center">
                                        <i class="fas fa-times-circle text-red-500 mr-2"></i>
                                        Reprovado em:
                                    </h5>
                                    <div class="flex flex-wrap gap-2">
                                        ${aluno.disciplinas_reprovado.map(disc =>
                                            `<span class="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-sm">${disc}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Disciplinas em Recupera√ß√£o -->
                            ${aluno.disciplinas_recuperacao.length > 0 ? `
                                <div>
                                    <h5 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center">
                                        <i class="fas fa-exclamation-circle text-orange-500 mr-2"></i>
                                        Em recupera√ß√£o:
                                    </h5>
                                    <div class="flex flex-wrap gap-2">
                                        ${aluno.disciplinas_recuperacao.map(disc =>
                                            `<span class="px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-full text-sm">${disc}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Disciplinas Aprovadas -->
                            ${aluno.disciplinas_aprovado.length > 0 ? `
                                <div>
                                    <h5 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center">
                                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                        Aprovado em:
                                    </h5>
                                    <div class="flex flex-wrap gap-2">
                                        ${aluno.disciplinas_aprovado.map(disc =>
                                            `<span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-sm">${disc}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });

        lista.innerHTML = html;
    }

    function toggleAlunoDetalhes(index) {
        const detalhes = document.getElementById(`detalhes-${index}`);
        const chevron = document.getElementById(`chevron-${index}`);

        if (detalhes.classList.contains('expandido')) {
            // Contrair
            detalhes.classList.remove('expandido');
            chevron.classList.remove('rotacionado');
        } else {
            // Expandir
            detalhes.classList.add('expandido');
            chevron.classList.add('rotacionado');
        }
    }

    function filtrarPorPrioridade(prioridade) {
        prioridadeFiltro = prioridade;

        // Atualizar bot√µes ativos
        document.querySelectorAll('.filtro-prioridade').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.prioridade === prioridade) {
                btn.classList.add('active');
            }
        });

        // Re-renderizar
        renderizarAlunosAtencao();
    }

    function carregarRankingMelhoresAlunos() {
        console.log('Carregando ranking dos melhores alunos...');

        const limite = document.getElementById('limite-ranking').value;
        const isProfessor = {{ 'true' if session.get('user_role') == 'professor' else 'false' }};
        const extra = isProfessor ? ('&disciplina=' + encodeURIComponent(document.getElementById('select-disciplina')?.value || '')) : '';
        fetch(`/api/ranking-melhores-alunos?limite=${limite}${extra}`, {
            headers: setAuthHeaders()
        })
            .then(response => {
                if (handleAuthError(response)) return;
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log('Dados do ranking dos melhores alunos:', data);
                    rankingMelhoresData = data.ranking;

                    // Mostrar/ocultar se√ß√µes apropriadas
                    if (data.ranking.length === 0) {
                        document.getElementById('loading-ranking-melhores').classList.add('hidden');
                        document.getElementById('lista-ranking-melhores').classList.add('hidden');
                        document.getElementById('empty-ranking-melhores').classList.remove('hidden');
                    } else {
                        document.getElementById('loading-ranking-melhores').classList.add('hidden');
                        document.getElementById('empty-ranking-melhores').classList.add('hidden');
                        document.getElementById('lista-ranking-melhores').classList.remove('hidden');

                        // Renderizar ranking
                        renderizarRankingMelhoresAlunos();
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar ranking dos melhores alunos:', error);
                document.getElementById('loading-ranking-melhores').innerHTML =
                    '<p class="text-red-500 dark:text-red-400 text-center">Erro ao carregar dados</p>';
            });
    }

    function renderizarRankingMelhoresAlunos() {
        const grid = document.getElementById('grid-ranking-melhores');

        if (rankingMelhoresData.length === 0) {
            grid.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">Nenhum aluno encontrado.</div>';
            return;
        }

        let html = '';
        rankingMelhoresData.forEach(aluno => {
            const posicaoClass = aluno.posicao <= 3 ? `posicao-${aluno.posicao}` : '';
            const medalIcon = getMedalIcon(aluno.posicao);

            // Classificar disciplinas por cores
            const disciplinasHtml = aluno.disciplinas.slice(0, 5).map(disc => {
                const classe = getClasseDisciplina(disc.media);
                return `<span class="disciplina-tag ${classe}">${disc.nome}: ${disc.media}</span>`;
            }).join('');

            const disciplinasExtras = aluno.disciplinas.length > 5 ?
                `<span class="text-xs text-gray-500 dark:text-gray-400">+${aluno.disciplinas.length - 5} mais</span>` : '';

            html += `
                <div class="ranking-item border-l-4 ${posicaoClass} p-4 rounded-lg border border-gray-200 dark:border-dark-600 bg-white dark:bg-dark-800">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <div class="flex items-center mr-3">
                                ${medalIcon}
                                <span class="text-lg font-bold text-gray-700 dark:text-gray-300">#${aluno.posicao}</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white">${aluno.nome}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    M√©dia Geral: <span class="font-bold text-green-600 dark:text-green-400">${aluno.media_geral}</span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Desempenho</div>
                            <div class="flex space-x-2 text-xs">
                                <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded">
                                    ${aluno.disciplinas_aprovado} aprovado(s)
                                </span>
                                ${aluno.disciplinas_recuperacao > 0 ? `
                                    <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded">
                                        ${aluno.disciplinas_recuperacao} recupera√ß√£o
                                    </span>
                                ` : ''}
                                ${aluno.disciplinas_reprovado > 0 ? `
                                    <span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded">
                                        ${aluno.disciplinas_reprovado} reprovado(s)
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400 mb-2">
                            <span>Melhores disciplinas:</span>
                            <span>Melhor: ${aluno.melhor_disciplina} (${aluno.melhor_nota})</span>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${disciplinasHtml}
                            ${disciplinasExtras}
                        </div>
                    </div>

                    ${aluno.pior_nota < 6.0 ? `
                        <div class="pt-2 border-t border-gray-200 dark:border-dark-600">
                            <p class="text-xs text-gray-600 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                Precisa melhorar em: <span class="font-medium text-orange-600 dark:text-orange-400">${aluno.pior_disciplina} (${aluno.pior_nota})</span>
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        grid.innerHTML = html;
    }

    function getMedalIcon(posicao) {
        switch(posicao) {
            case 1:
                return '<i class="fas fa-medal medal-icon-1 mr-2 text-lg"></i>';
            case 2:
                return '<i class="fas fa-medal medal-icon-2 mr-2 text-lg"></i>';
            case 3:
                return '<i class="fas fa-medal medal-icon-3 mr-2 text-lg"></i>';
            default:
                return '<i class="fas fa-user mr-2 text-gray-400"></i>';
        }
    }

    function getClasseDisciplina(media) {
        if (media >= 9.0) return 'disciplina-excelente';
        if (media >= 7.0) return 'disciplina-boa';
        if (media >= 6.0) return 'disciplina-media';
        return 'disciplina-baixa';
    }

    // Fun√ß√£o para alternar entre se√ß√µes
    function mostrarSecao(secao) {
        // Ocultar todas as se√ß√µes
        document.getElementById('secao-turma').classList.add('hidden');
        document.getElementById('secao-alunos').classList.add('hidden');

        // Remover classe active de todos os bot√µes
        document.getElementById('btn-secao-turma').classList.remove('active');
        document.getElementById('btn-secao-alunos').classList.remove('active');

        // Mostrar se√ß√£o selecionada e ativar bot√£o
        if (secao === 'turma') {
            document.getElementById('secao-turma').classList.remove('hidden');
            document.getElementById('btn-secao-turma').classList.add('active');
        } else if (secao === 'alunos') {
            document.getElementById('secao-alunos').classList.remove('hidden');
            document.getElementById('btn-secao-alunos').classList.add('active');
        }
    }
</script>
{% endblock %}
